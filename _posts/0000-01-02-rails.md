---
layout: default
title:  "Using with Rails"
tag: main
---

# Using with Rails
## Setup
Gemfile:
{% highlight ruby %}
gem 'dragonfly', "~>1.0"
{% endhighlight %}

Command line:

```
rails generate dragonfly
```
This generates a file in `config/initializers/dragonfly.rb`. <br />
See [Configuration]({% post_url 0000-02-01-configuration %}) for customizations.

## Handling attachments
Migration:

{% highlight ruby %}
add_column :photos, :image_uid,  :string
add_column :photos, :image_name, :string  # Optional - if you want urls
                                          # to end with the original filename
{% endhighlight %}

Model:

{% highlight ruby %}
class Photo < ActiveRecord::Base
  dragonfly_accessor :image    # defines a reader/writer for image
  # ...
end
{% endhighlight %}

View for uploading:

{% highlight erb %}
<% form_for @photo, :html => {:multipart => true} do |f| %>
  ...
  <%= f.file_field :image %>
  ...
<% end %>
{% endhighlight %}

REMEMBER THE MULTIPART BIT!

View for displaying:

{% highlight erb %}
<%= image_tag @photo.image.thumb('400x200#').url if @photo.image_stored? %>
{% endhighlight %}

### More with models...
There are many more things you can do with models, such as making thumbnails on upload, or persisting attachments even when validations fail.<br />
See [Models]({% post_url 0000-01-04-models %}) for more details.

## Custom endpoints
`routes.rb`:

Text generation example
{% highlight ruby %}
get "text/:text" => Dragonfly.app.endpoint { |params, app|
  app.generate(:text, params[:text], 'font-size' => 42)
}
{% endhighlight%}

Endpoint callable from javascript. e.g. `/image/egg.png?size=30x30`
{% highlight ruby %}
get "image/:filename" => Dragonfly.app.endpoint { |params, app|
  app.fetch_file(Rails.root.join('public/imgs', "#{params[:filename]}.#{params[:format]}").thumb(params[:size])
}
{% endhighlight%}


