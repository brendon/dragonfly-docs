---
layout: default
title:  "Caching/Performance"
tag: main
---

# Caching and Performance
Dragonfly serves content *on-the-fly*, that is, if make a request to a url given by
{% highlight ruby %}
url = Dragonfly.app.fetch('my/stored/image').thumb('300x200').url
{% endhighlight %}

then Dragonfly will do exactly what the job says, i.e.

  1. fetch the content stored with uid "my/stored/image"
  2. process it to make a thumbnail with dimensions 300x200

Doing this on every request is expensive, so it's wise to use a caching proxy, so that after the first
request the server simply returns the cached response.

Dragonfly sends `Cache-Control` and `ETag` headers in its responses to let us do this (for a well-written discussion of this, see [this blog post](http://tomayko.com/writings/things-caches-do)).

Simply put a proxy like [Rack::Cache](http://rtomayko.github.com/rack-cache), [Varnish](http://varnish.projects.linpro.no) or [Squid](http://www.squid-cache.org) in front of the app and subsequent requests will be served super-quickly straight out of the cache.

For simple use of Rack::Cache with rails see [Rails]({% post_url 0000-01-02-rails %}#caching).

To customize Dragonfly's response headers, inside a `configure` block, you can use something like

{% highlight ruby %}
response_header "Cache-Control", "public, max-age=3600"
{% endhighlight %}

or

{% highlight ruby %}
response_header "Cache-Control" do |job, request, headers|
  if job.fetch_step && job.fetch_step.uid =~ /2012/
    "public, max-age=100000"
  else
    "private"
  end
end
{% endhighlight %}

Setting the header to `nil` removes the header from the response.

## Using a CDN
Some CDNs are configured to make a request to your domain on the first request and return the cached version thereafter, using the same url path.

You can use `url_host` to point urls to the CDN instead of your local server.

For example, a url
{% highlight ruby %}
Dragonfly.app.fetch('some/uid').thumb('300x200').url
{% endhighlight %}

normally returns something like
{% highlight ruby %}
"/W1siZiIsInNvbWUvdWlkIl0sWyJwIiwidGh1bWIiLCIzMDB4MjAwIl1d"
{% endhighlight %}

Adding in a `configure` block
{% highlight ruby %}
url_host 'http://some.cdn'
{% endhighlight %}

makes the url
{% highlight ruby %}
"http://some.cdn/W1siZiIsInNvbWUvdWlkIl0sWyJwIiwidGh1bWIiLCIzMDB4MjAwIl1d"
{% endhighlight %}

## Serving remotely (directly from the datastore)

## Performing processing on upload

## Processing *on-the-fly* and serving remotely
